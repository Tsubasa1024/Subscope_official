<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>記事 | SUBSCOPE</title>

  <!-- Canonical（JSで上書き） -->
  <link rel="canonical" href="https://www.subscope.jp/article.html">

  <!-- OGP（JSで上書き） -->
  <meta property="og:type" content="article">
  <meta property="og:site_name" content="SUBSCOPE">
  <meta property="og:title" content="記事 | SUBSCOPE">
  <meta property="og:description" content="">
  <meta property="og:url" content="">
  <meta property="og:image" content="https://www.subscope.jp/ogp-default-v3.png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image">

  <!-- Google tag -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-9FCHPHJTVE"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-9FCHPHJTVE');
  </script>

  <style>
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      background:#fff;
      color:#1d1d1f;
      line-height:1.7;
    }
    a{text-decoration:none;color:inherit}

    .container{
      max-width:800px;
      margin:0 auto;
      padding:96px 24px 80px;
    }

    .article-hero img{
      width:100%;
      border-radius:20px;
      margin-bottom:24px;
    }

    .article-meta{
      color:#86868b;
      font-size:.85rem;
      margin-bottom:8px;
    }

    h1{
      font-size:2.2rem;
      line-height:1.35;
      letter-spacing:-.02em;
      margin-bottom:12px;
    }

    .article-desc{
      font-size:1.05rem;
      color:#555;
      margin-bottom:32px;
    }

    .article-content{
      font-size:1.05rem;
    }

    .article-content img{
      max-width:100%;
      border-radius:16px;
    }

    .article-footer{
      margin-top:64px;
      padding-top:32px;
      border-top:1px solid #e5e5ea;
      display:flex;
      justify-content:space-between;
      align-items:center;
      flex-wrap:wrap;
      gap:16px;
    }

    .back-link{
      font-size:.9rem;
      color:#0071e3;
    }
  </style>
</head>

<body>

  <main class="container" id="articleMount">
    <p>記事を読み込み中…</p>
  </main>

<script>
/* ===============================
   article.html logic
   =============================== */

(async () => {
  const params = new URLSearchParams(location.search);
  const articleId = params.get("id");

  if (!articleId) {
    document.getElementById("articleMount").innerHTML =
      "<p>記事IDが指定されていません。</p>";
    return;
  }

  // index.js で公開している値を利用
  const SERVICE_ID = window.SERVICE_ID;
  const API_KEY = window.API_KEY;

  if (!SERVICE_ID || !API_KEY) {
    document.getElementById("articleMount").innerHTML =
      "<p>設定エラーが発生しました。</p>";
    return;
  }

  const ENDPOINT = `https://${SERVICE_ID}.microcms.io/api/v1/articles/${articleId}`;

  try {
    const res = await fetch(ENDPOINT, {
      headers: { "X-MICROCMS-API-KEY": API_KEY }
    });
    if (!res.ok) throw new Error("fetch failed");

    const item = await res.json();

    /* ===============================
       GA4：記事閲覧イベント（超重要）
       =============================== */
    window.gtag?.("event", "article_view", {
      article_id: item.id,
      article_title: item.title || "",
      category: item.category?.name || "",
    });

    /* ===============================
       SEO / OGP 差し替え
       =============================== */
    document.title = `${item.title} | SUBSCOPE`;
    document.querySelector("link[rel='canonical']").href =
      `https://www.subscope.jp/article.html?id=${item.id}`;

    const setMeta = (prop, value) => {
      const el = document.querySelector(prop);
      if (el && value) el.setAttribute("content", value);
    };

    setMeta("meta[property='og:title']", item.title);
    setMeta("meta[property='og:description']", item.description);
    setMeta("meta[property='og:url']",
      `https://www.subscope.jp/article.html?id=${item.id}`);
    setMeta("meta[property='og:image']",
      item.eyecatch?.url || "https://www.subscope.jp/ogp-default-v3.png");

    /* ===============================
       HTML描画
       =============================== */
    document.getElementById("articleMount").innerHTML = `
      <article>
        <div class="article-hero">
          <img src="${item.eyecatch?.url || "https://placehold.co/1200x630"}" alt="">
        </div>

        <div class="article-meta">
          ${item.publishedAt?.slice(0,10).replace(/-/g,".") || ""}
          ・ ${item.category?.name || ""}
        </div>

        <h1>${item.title}</h1>

        <p class="article-desc">
          ${item.description || ""}
        </p>

        <div class="article-content">
          ${item.content || ""}
        </div>

        <div class="article-footer">
          <a href="all.html" class="back-link">← 記事一覧へ戻る</a>
        </div>
      </article>
    `;

  } catch (e) {
    console.error(e);
    document.getElementById("articleMount").innerHTML =
      "<p>記事の読み込みに失敗しました。</p>";
  }
})();
</script>

</body>
</html>
