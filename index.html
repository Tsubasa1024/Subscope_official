/* =========================================
   SUBSCOPE index.js 完全版
   - localStorage でビュー数記録
   - 1番人気を HERO に表示
   - 最新記事 3×3 の9件表示（広告1つ含む）
   - 全ページ共通で動作
========================================= */

/* -------------------------
   ① 記事データ読み込み
------------------------- */
async function loadArticles() {
  const res = await fetch("./data/articles.json");
  const data = await res.json();
  return data;
}

/* -------------------------
   ② ビュー数を localStorage 管理
------------------------- */
function getViews(id) {
  return Number(localStorage.getItem("views_" + id) || 0);
}

function addView(id) {
  const current = getViews(id);
  localStorage.setItem("views_" + id, current + 1);
}

/* -------------------------
   ③ HERO：最も見られた記事を表示
------------------------- */
async function renderHero() {
  const container = document.getElementById("most-viewed-content");
  if (!container) return;

  const articles = await loadArticles();

  // localStorage のビュー数をマージ
  articles.forEach(a => (a.localViews = getViews(a.id)));

  // 一番見られてる記事
  const top = [...articles].sort((a, b) => b.localViews - a.localViews)[0];

  container.innerHTML = `
    <div class="featured-card" style="background-image: url('${top.image}')" onclick="openArticle(${top.id})">
      <div class="featured-content">
        <div class="featured-meta">
          <span class="tag">${top.genre}</span>
        </div>
        <h2 class="featured-title">${top.title}</h2>
        <p class="featured-desc">${top.description}</p>
        <button class="btn-read">続きを読む</button>
      </div>
    </div>
  `;
}

/* -------------------------
   ④ 最新記事 3×3（広告含む）
------------------------- */
async function renderLatest() {
  const grid = document.getElementById("latest-grid");
  if (!grid) return;

  const articles = await loadArticles();

  // 新しい順
  const latest = [...articles]
    .sort((a, b) => new Date(b.date) - new Date(a.date))
    .slice(0, 8); // 8記事まで

  // ★ 9マス目は広告（差し替え可能）
  const AD = {
    isAd: true,
    image: "https://images.unsplash.com/photo-1503602642458-232111445657?q=80&w=1000&auto=format&fit=crop",
    title: "AD — SUBSCOPE パートナー募集中",
    desc: "あなたのサービスをここに掲載しませんか？",
  };

  const cards = [...latest, AD];

  grid.innerHTML = cards
    .map(item => {
      if (item.isAd) {
        return `
          <div class="article-card">
            <div class="card-image" style="background-image:url('${item.image}')"></div>
            <div class="card-body">
              <div class="card-title">${item.title}</div>
              <div class="card-desc">${item.desc}</div>
            </div>
          </div>
        `;
      }

      return `
        <div class="article-card" onclick="openArticle(${item.id})">
          <div class="card-image" style="background-image:url('${item.image}')"></div>
          <div class="card-body">
            <div class="card-service">${item.service}</div>
            <div class="card-title">${item.title}</div>
            <div class="card-date">${item.date.replace(/-/g, ".")}</div>
            <div class="card-desc">${item.description}</div>
          </div>
        </div>
      `;
    })
    .join("");
}

/* -------------------------
   ⑤ ランキングページ（ranking.html）
------------------------- */
async function renderRanking() {
  const wrapper = document.getElementById("ranking-list");
  if (!wrapper) return;

  const articles = await loadArticles();

  articles.forEach(a => (a.localViews = getViews(a.id)));

  const sorted = [...articles].sort((a, b) => b.localViews - a.localViews);

  wrapper.innerHTML = sorted
    .map((a, i) => {
      return `
        <div class="ranking-item">
          <div class="rank-number">${i + 1}</div>
          <img class="rank-thumb" src="${a.image}" />
          <div class="rank-content">
            <div class="rank-title" onclick="openArticle(${a.id})">${a.title}</div>
            <div class="rank-meta">${a.localViews} views ｜ ${a.service}</div>
          </div>
        </div>
      `;
    })
    .join("");
}

/* -------------------------
   ⑥ 記事ページ（article.html）
------------------------- */
async function renderArticlePage() {
  const container = document.getElementById("article-body");
  if (!container) return;

  const params = new URLSearchParams(window.location.search);
  const id = Number(params.get("id"));

  const articles = await loadArticles();
  const article = articles.find(a => a.id === id);

  if (!article) {
    container.innerHTML = "<p>記事が見つかりませんでした。</p>";
    return;
  }

  // ビュー数を追加
  addView(id);

  container.innerHTML = `
    <h1>${article.title}</h1>
    <p style="color:#888; margin-bottom:20px;">${article.date}</p>
    <img src="${article.image}" style="width:100%; border-radius:16px; margin-bottom:20px;">
    <p style="font-size:1.05rem; line-height:1.7;">
      ${article.description}
    </p>
  `;
}

/* -------------------------
   ⑦ ジャンル一覧ページ（service.html）
------------------------- */
async function renderGenreList() {
  const grid = document.getElementById("genre-grid");
  if (!grid) return;

  const articles = await loadArticles();

  const map = {};

  articles.forEach(a => {
    if (!map[a.genre]) map[a.genre] = 0;
    map[a.genre]++;
  });

  grid.innerHTML = Object.keys(map)
    .map(
      g => `
      <div class="genre-card" onclick="location.href='all.html?tab=${encodeURIComponent(
        g
      )}'">
        <div class="genre-title">${g}</div>
        <div class="genre-count">${map[g]} 件</div>
      </div>
    `
    )
    .join("");
}

/* -------------------------
   ⑧ ナビ（Menu）開閉
------------------------- */
function toggleMenu() {
  document.getElementById("nav-overlay").classList.toggle("open");
}

/* -------------------------
   ⑨ 記事移動ショートカット
------------------------- */
function openArticle(id) {
  window.location.href = "article.html?id=" + id;
}

/* -------------------------
   ⑩ ページごとに初期化
------------------------- */
document.addEventListener("DOMContentLoaded", () => {
  renderHero();
  renderLatest();
  renderRanking();
  renderArticlePage();
  renderGenreList();
});
<!-- 最後に必ず入れる -->
<script src="./index.js"></script>
</body>
</html>
